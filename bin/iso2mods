#!/bin/bash
#
# iso2mods - Convert MEF into MODS descMetadata_xxx.xml
# NOTE: Ruby's Nokogiri transformation breaks with iso2mods.xsl
#
function usage () {
  echo "Usage: iso2mods [srcdir [destdir]]"
  exit -1
}

d=${1:-tmp}
destdir=${2:-data}
test -d "$d" || usage
test -d "$destdir" || usage

echo "Processing $d for MEF data"
for fn in $d/*.mef; do
  unzip -qo $fn -d $d
  uuid=$(basename $fn .mef)
  echo "Transforming $uuid -> $destdir/descMetadata_$uuid.xml"
  xsltproc lib/geomdtk/iso2mods.xsl $d/$uuid/metadata/metadata.xml > $destdir/descMetadata_$uuid.xml
done

find $d -name '*.shp.xml' | while read fn; do
  f=$destdir/$(basename $fn .shp.xml | tr / _ | tr A-Z a-z)_iso19139.xml
  echo "Transforming $fn -> $f"
  xsltproc lib/geomdtk/ArcGIS2ISO19139.xslt $fn > $f
done

find $destdir -name '*_iso19139.xml' | while read fn; do
  f=$destdir/descMetadata_$(basename $fn _iso19139.xml).xml
  echo "Transforming $fn -> $f"
  xsltproc lib/geomdtk/iso2mods.xsl $fn > $f
done
